<!DOCTYPE html>
<html>
<head>
    <title>è¯­éŸ³è½¬æ–‡å­—åº”ç”¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        button {
            padding: 10px 20px;
            font-size: 18px;
            margin-top: 20px;
        }
        #output {
            margin-top: 20px;
            font-size: 18px;
        }
        #chinese-text {
            color: blue;
        }
        #english-text {
            color: green;
        }
        .action-buttons {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h1>ğŸ™ï¸ è¯­éŸ³è½¬æ–‡å­— - ä¸­æ–‡è½¬è‹±æ–‡</h1>

<button id="recordButton">ğŸ™ï¸ å¼€å§‹å½•éŸ³</button>
<button id="stopButton" disabled>â¹ï¸ åœæ­¢å½•éŸ³</button>

<div id="output">
    <p id="chinese-text">ğŸ“ ä¸­æ–‡ï¼šç­‰å¾…å½•éŸ³ç»“æœ...</p>
    <p id="english-text">ğŸ“š è‹±æ–‡ï¼šç­‰å¾…ç¿»è¯‘ç»“æœ...</p>
</div>

<div class="action-buttons" id="actionButtons" style="display: none;">
    <button id="confirmButton">âœ… ç¡®è®¤</button>
    <button id="cancelButton">âŒ å–æ¶ˆ</button>
    <button id="retryButton">ğŸ” é‡è¯•</button>
</div>

<script>
    let mediaRecorder;
    let audioChunks = [];
    let currentOriginalText = "";
    let currentTranslatedText = "";

    // å½•éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById("recordButton").addEventListener("click", async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio', audioBlob, 'audio.wav');

            // ä¸Šä¼ éŸ³é¢‘åˆ°æœåŠ¡å™¨
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (response.ok) {
                currentOriginalText = result.original_text;
                currentTranslatedText = result.translated_text;

                document.getElementById("chinese-text").innerText = `ğŸ“ ä¸­æ–‡ï¼š${result.original_text}`;
                document.getElementById("english-text").innerText = `ğŸ“š è‹±æ–‡ï¼š${result.translated_text}`;
                document.getElementById("actionButtons").style.display = "block";
            } else {
                document.getElementById("output").innerHTML = `â— å‡ºé”™: ${result.error}`;
            }

            // ç¦ç”¨å½•éŸ³å’Œåœæ­¢æŒ‰é’®
            document.getElementById("recordButton").disabled = true;
            document.getElementById("stopButton").disabled = true;
        };

        mediaRecorder.start();
        document.getElementById("recordButton").disabled = true;
        document.getElementById("stopButton").disabled = false;
    });

    // åœæ­¢å½•éŸ³æŒ‰é’®
    document.getElementById("stopButton").addEventListener("click", () => {
        mediaRecorder.stop();
        document.getElementById("recordButton").disabled = true;
        document.getElementById("stopButton").disabled = true;
    });

    // ç¡®è®¤æŒ‰é’® - ä¿å­˜ç¿»è¯‘åˆ° log.txt
    document.getElementById("confirmButton").addEventListener("click", async () => {
        const response = await fetch('/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                original_text: currentOriginalText,
                translated_text: currentTranslatedText
            })
        });

        const result = await response.json();
        if (response.ok) {
            alert("âœ… ç¿»è¯‘ç»“æœå·²ä¿å­˜ï¼");
        } else {
            alert(`â— å‡ºé”™: ${result.error}`);
        }
        resetUI();
    });

    // å–æ¶ˆæŒ‰é’® - ä¸ä¿å­˜ç»“æœ
    document.getElementById("cancelButton").addEventListener("click", () => {
        alert("âŒ å·²å–æ¶ˆï¼Œä¸ä¿å­˜ç»“æœã€‚");
        resetUI();
    });

    // é‡è¯•æŒ‰é’® - é‡æ–°å½•éŸ³
    // é‡è¯•æŒ‰é’® - é‡æ–°å½•éŸ³
    document.getElementById("retryButton").addEventListener("click", async () => {
        resetUI();

        // ç›´æ¥å¼€å§‹å½•éŸ³
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio', audioBlob, 'audio.wav');

            // ä¸Šä¼ éŸ³é¢‘åˆ°æœåŠ¡å™¨
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (response.ok) {
                currentOriginalText = result.original_text;
                currentTranslatedText = result.translated_text;

                document.getElementById("chinese-text").innerText = `ğŸ“ ä¸­æ–‡ï¼š${result.original_text}`;
                document.getElementById("english-text").innerText = `ğŸ“š è‹±æ–‡ï¼š${result.translated_text}`;
                document.getElementById("actionButtons").style.display = "block";
            } else {
                document.getElementById("output").innerHTML = `â— å‡ºé”™: ${result.error}`;
            }

            // ç¦ç”¨å½•éŸ³å’Œåœæ­¢æŒ‰é’®
            document.getElementById("recordButton").disabled = true;
            document.getElementById("stopButton").disabled = true;
        };

        mediaRecorder.start();
        document.getElementById("recordButton").disabled = true;
        document.getElementById("stopButton").disabled = false;
    });

    // é‡ç½®ç•Œé¢
    function resetUI() {
        document.getElementById("chinese-text").innerText = "ğŸ“ ä¸­æ–‡ï¼šç­‰å¾…å½•éŸ³ç»“æœ...";
        document.getElementById("english-text").innerText = "ğŸ“š è‹±æ–‡ï¼šç­‰å¾…ç¿»è¯‘ç»“æœ...";
        document.getElementById("actionButtons").style.display = "none";
        currentOriginalText = "";
        currentTranslatedText = "";
        audioChunks = []; // æ¸…é™¤éŸ³é¢‘ç¼“å­˜
        document.getElementById("recordButton").disabled = false;
        document.getElementById("stopButton").disabled = true;
    }
</script>

</body>
</html>