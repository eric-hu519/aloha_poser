<!DOCTYPE html>
<html>
<head>
    <title>è¯­éŸ³è½¬æ–‡å­—åº”ç”¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        button {
            padding: 10px 20px;
            font-size: 18px;
            margin-top: 20px;
        }
        #output {
            margin-top: 20px;
            font-size: 18px;
        }
        #chinese-text {
            color: blue;
        }
        #english-text {
            color: green;
        }
        .action-buttons {
            margin-top: 20px;
        }
        #taskResult {
            margin-top: 30px;
            text-align: left;
            display: inline-block;
            width: 80%;
            white-space: pre-wrap;
        }
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        #executeTaskButton {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 0 5px;
        }
        #executeTaskButton:hover {
            background-color: #45a049;
        }
        #executeTaskButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #stopExecutionButton {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 0 5px;
        }
        #stopExecutionButton:hover {
            background-color: #da190b;
        }
        #executionStatus {
            background-color: #f0f8ff;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin: 20px auto;
            width: 80%;
        }
    </style>
</head>
<body>

<h1>ğŸ™ï¸ è¯­éŸ³è½¬æ–‡å­— - ä¸­æ–‡è½¬è‹±æ–‡</h1>

<button id="recordButton">ğŸ™ï¸ å¼€å§‹å½•éŸ³</button>
<button id="stopButton" disabled>â¹ï¸ åœæ­¢å½•éŸ³</button>

<div id="output">
    <p id="chinese-text">ğŸ“ ä¸­æ–‡ï¼šç­‰å¾…å½•éŸ³ç»“æœ...</p>
    <p id="english-text">ğŸ“š è‹±æ–‡ï¼šç­‰å¾…ç¿»è¯‘ç»“æœ...</p>
</div>

<div class="action-buttons" id="actionButtons" style="display: none;">
    <button id="confirmButton">âœ… ç¡®è®¤</button>
    <button id="cancelButton">âŒ å–æ¶ˆ</button>
    <button id="retryButton">ğŸ” é‡è¯•</button>
</div>

<!-- æ·»åŠ ä½¿ç”¨ç¼“å­˜å¤é€‰æ¡† -->
<div>
    <label>
        <input type="checkbox" id="useCachedCheckbox"> ä½¿ç”¨ç¼“å­˜æ•°æ®
    </label>
</div>

<!-- ä¿®æ”¹åçš„ä»»åŠ¡ç»“æœå±•ç¤º -->
<div id="taskResult" style="display: none;">
    <h2>ğŸ“š ä»»åŠ¡åˆ†è§£ä¸åŠ¨ä½œç”Ÿæˆç»“æœ</h2>
    <div id="taskTableContainer">
        <table id="taskTable" border="1" cellspacing="0" cellpadding="5">
            <thead>
                <tr>
                    <th>æ­¥éª¤</th>
                    <th>ä»»åŠ¡æè¿°</th>
                    <th>åŠ¨ä½œåˆ—è¡¨</th>
                </tr>
            </thead>
            <tbody id="taskTableBody"></tbody>
        </table>
    </div>
    <button id="confirmTaskButton">âœ… ç¡®è®¤ä¿å­˜</button>
    <button id="executeTaskButton" style="background-color: #4CAF50; color: white;">ğŸ¤– æ‰§è¡ŒåŠ¨ä½œåºåˆ—</button>
    <button id="stopExecutionButton" style="background-color: #f44336; color: white; display: none;">â¹ï¸ åœæ­¢æ‰§è¡Œ</button>
    <button id="cancelTaskButton">âŒ å–æ¶ˆ</button>
</div>

<!-- æ·»åŠ æ‰§è¡ŒçŠ¶æ€æ˜¾ç¤º -->
<div id="executionStatus" style="display: none; margin-top: 20px;">
    <h3>ğŸ¤– æ‰§è¡ŒçŠ¶æ€</h3>
    <div id="executionMessage"></div>
</div>

<script>
    let mediaRecorder;
    let audioChunks = [];
    let currentOriginalText = "";
    let currentTranslatedText = "";
    let currentActionSequence = null; // å­˜å‚¨å½“å‰çš„åŠ¨ä½œåºåˆ—
    let currentProcessId = null; // å­˜å‚¨å½“å‰æ‰§è¡Œè¿›ç¨‹çš„ID
    let statusCheckInterval = null; // çŠ¶æ€æ£€æŸ¥å®šæ—¶å™¨

    // å½•éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById("recordButton").addEventListener("click", async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio', audioBlob, 'audio.wav');

            // ä¸Šä¼ éŸ³é¢‘åˆ°æœåŠ¡å™¨
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (response.ok) {
                currentOriginalText = result.original_text;
                currentTranslatedText = result.translated_text;

                document.getElementById("chinese-text").innerText = `ğŸ“ ä¸­æ–‡ï¼š${result.original_text}`;
                document.getElementById("english-text").innerText = `ğŸ“š è‹±æ–‡ï¼š${result.translated_text}`;
                document.getElementById("actionButtons").style.display = "block";
            } else {
                document.getElementById("output").innerHTML = `â— å‡ºé”™: ${result.error}`;
            }

            // ç¦ç”¨å½•éŸ³å’Œåœæ­¢æŒ‰é’®
            document.getElementById("recordButton").disabled = true;
            document.getElementById("stopButton").disabled = true;
        };

        mediaRecorder.start();
        document.getElementById("recordButton").disabled = true;
        document.getElementById("stopButton").disabled = false;
    });

    // åœæ­¢å½•éŸ³æŒ‰é’®
    document.getElementById("stopButton").addEventListener("click", () => {
        mediaRecorder.stop();
        document.getElementById("recordButton").disabled = true;
        document.getElementById("stopButton").disabled = true;
    });

    // ç¡®è®¤æŒ‰é’® - ç›´æ¥è°ƒç”¨ processUserQuery å¤„ç†ç¿»è¯‘ç»“æœ
    document.getElementById("confirmButton").addEventListener("click", async () => {
        document.getElementById("taskTableBody").innerHTML = "<tr><td colspan='3'>âŒ› æ­£åœ¨å¤„ç†è¯·æ±‚ä¸­...</td></tr>";
        document.getElementById("taskResult").style.display = "block";
        processUserQuery(currentOriginalText);
    });

    // å¤„ç†ä»»åŠ¡åˆ†è§£
    async function processUserQuery(userQuery) {
        const useCached = document.getElementById('useCachedCheckbox').checked;

        try {
            const response = await fetch('/process_query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_query: userQuery, use_cached: useCached })
            });

            const result = await response.json();
            if (response.ok && result.success) {
                displayTaskResults(result.result);
            } else {
                document.getElementById('taskTableBody').innerHTML = `<tr><td colspan="3">â— å‡ºé”™: ${result.error}</td></tr>`;
                document.getElementById('taskResult').style.display = "block";
            }
        } catch (error) {
            document.getElementById('taskTableBody').innerHTML = `<tr><td colspan="3">â— è¯·æ±‚å¤±è´¥: ${error.message}</td></tr>`;
            document.getElementById('taskResult').style.display = "block";
        }
    }

    // ä¼˜åŒ–åçš„ä»»åŠ¡ç»“æœæ˜¾ç¤ºå‡½æ•°
    function displayTaskResults(taskResults) {
        const taskTableBody = document.getElementById('taskTableBody');
        taskTableBody.innerHTML = ""; // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
        
        // ä¿å­˜å½“å‰çš„åŠ¨ä½œåºåˆ—
        currentActionSequence = taskResults;

    taskResults.forEach((task, index) => {
        const row = document.createElement('tr');

        // æ­¥éª¤ç¼–å·
        const stepCell = document.createElement('td');
        stepCell.innerText = `æ­¥éª¤ ${index + 1}`;
        row.appendChild(stepCell);

        // ä»»åŠ¡æè¿°
        const taskCell = document.createElement('td');
        taskCell.innerText = task.step;
        row.appendChild(taskCell);

        // åŠ¨ä½œåˆ—è¡¨
        const actionCell = document.createElement('td');
        if (task.actions && task.actions.length > 0) {
            const actionsTable = document.createElement('table');
            actionsTable.style.width = "100%";
            actionsTable.style.borderCollapse = "collapse";

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['åŠ¨ä½œç±»å‹', 'åŠ¨ä½œåç§°', 'åŠ¨ä½œå‚æ•°'].forEach(headerText => {
                const th = document.createElement('th');
                th.innerText = headerText;
                th.style.border = "1px solid #ddd";
                th.style.padding = "5px";
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            actionsTable.appendChild(thead);

            const tbody = document.createElement('tbody');
            task.actions.forEach(action => {
                const actionRow = document.createElement('tr');

                const typeCell = document.createElement('td');
                typeCell.innerText = action.type || "";
                typeCell.style.border = "1px solid #ddd";
                typeCell.style.padding = "5px";
                actionRow.appendChild(typeCell);

                const nameCell = document.createElement('td');
                nameCell.innerText = action.name || "";
                nameCell.style.border = "1px solid #ddd";
                nameCell.style.padding = "5px";
                actionRow.appendChild(nameCell);

                const argsCell = document.createElement('td');
                argsCell.innerText = formatActionArgs(action.args);
                argsCell.style.border = "1px solid #ddd";
                argsCell.style.padding = "5px";
                actionRow.appendChild(argsCell);

                tbody.appendChild(actionRow);
            });
            actionsTable.appendChild(tbody);
            actionCell.appendChild(actionsTable);
        } else {
            actionCell.innerText = "æ— åŠ¨ä½œ";
        }
        row.appendChild(actionCell);

        // æ·»åŠ è¡Œåˆ°è¡¨æ ¼
        taskTableBody.appendChild(row);
    });

    document.getElementById('taskResult').style.display = "block";
    }

// è¾…åŠ©å‡½æ•°æ ¼å¼åŒ–å‚æ•°
function formatActionArgs(args) {
    if (!args) return "æ— å‚æ•°";
    const filteredArgs = Object.keys(args)
        .filter(key => args[key] !== null && args[key] !== undefined)
        .map(key => `${key}: ${args[key]}`)
        .join(", ");
    return filteredArgs || "æ— æœ‰æ•ˆå‚æ•°";
}

    // ç¡®è®¤ä¿å­˜ä»»åŠ¡ç»“æœ
    document.getElementById("confirmTaskButton").addEventListener("click", async () => {
        alert("âœ… ä»»åŠ¡å’ŒåŠ¨ä½œå·²ä¿å­˜ï¼");
        resetUI();
    });

    // æ‰§è¡ŒåŠ¨ä½œåºåˆ—æŒ‰é’®
    document.getElementById("executeTaskButton").addEventListener("click", async () => {
        if (!currentActionSequence) {
            alert("â— æ²¡æœ‰å¯æ‰§è¡Œçš„åŠ¨ä½œåºåˆ—");
            return;
        }

        // ç¡®è®¤æ‰§è¡Œ
        if (!confirm("ğŸ¤– ç¡®å®šè¦æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œåºåˆ—å—ï¼Ÿ\n\næ³¨æ„ï¼šæœºå™¨äººå°†å¼€å§‹æ‰§è¡Œå®é™…åŠ¨ä½œï¼")) {
            return;
        }

        // æ˜¾ç¤ºæ‰§è¡ŒçŠ¶æ€
        document.getElementById("executionStatus").style.display = "block";
        document.getElementById("executionMessage").innerHTML = "âŒ› æ­£åœ¨å¯åŠ¨æ‰§è¡Œè¿›ç¨‹...";
        
        // ç¦ç”¨æ‰§è¡ŒæŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
        document.getElementById("executeTaskButton").disabled = true;
        document.getElementById("executeTaskButton").innerText = "ğŸ¤– æ‰§è¡Œä¸­...";

        try {
            // å¯åŠ¨æ‰§è¡Œè¿›ç¨‹
            const response = await fetch('/execute_actions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action_sequence: currentActionSequence })
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
                currentProcessId = result.process_id;
                document.getElementById("executionMessage").innerHTML = "ğŸ¤– æ‰§è¡Œè¿›ç¨‹å·²å¯åŠ¨ï¼Œæ­£åœ¨ç›‘æ§çŠ¶æ€...";
                
                // æ˜¾ç¤ºåœæ­¢æŒ‰é’®
                document.getElementById("stopExecutionButton").style.display = "inline-block";
                
                // å¼€å§‹ç›‘æ§æ‰§è¡ŒçŠ¶æ€
                startStatusMonitoring();
            } else {
                document.getElementById("executionMessage").innerHTML = `â— å¯åŠ¨å¤±è´¥: ${result.error}`;
                document.getElementById("executionMessage").style.color = "red";
                // é‡æ–°å¯ç”¨æ‰§è¡ŒæŒ‰é’®
                document.getElementById("executeTaskButton").disabled = false;
                document.getElementById("executeTaskButton").innerText = "ğŸ¤– æ‰§è¡ŒåŠ¨ä½œåºåˆ—";
            }
        } catch (error) {
            document.getElementById("executionMessage").innerHTML = `â— å¯åŠ¨å‡ºé”™: ${error.message}`;
            document.getElementById("executionMessage").style.color = "red";
            // é‡æ–°å¯ç”¨æ‰§è¡ŒæŒ‰é’®
            document.getElementById("executeTaskButton").disabled = false;
            document.getElementById("executeTaskButton").innerText = "ğŸ¤– æ‰§è¡ŒåŠ¨ä½œåºåˆ—";
        }
    });

    // åœæ­¢æ‰§è¡ŒæŒ‰é’®
    document.getElementById("stopExecutionButton").addEventListener("click", async () => {
        if (!currentProcessId) {
            return;
        }

        if (!confirm("âš ï¸ ç¡®å®šè¦åœæ­¢æ‰§è¡Œå—ï¼Ÿè¿™å¯èƒ½ä¼šå¯¼è‡´æœºå™¨äººåŠ¨ä½œä¸­æ–­ï¼")) {
            return;
        }

        try {
            const response = await fetch(`/stop_execution/${currentProcessId}`, {
                method: 'POST'
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
                document.getElementById("executionMessage").innerHTML = "â¹ï¸ æ‰§è¡Œå·²åœæ­¢";
                document.getElementById("executionMessage").style.color = "orange";
                stopStatusMonitoring();
            } else {
                document.getElementById("executionMessage").innerHTML = `â— åœæ­¢å¤±è´¥: ${result.error}`;
                document.getElementById("executionMessage").style.color = "red";
            }
        } catch (error) {
            document.getElementById("executionMessage").innerHTML = `â— åœæ­¢å‡ºé”™: ${error.message}`;
            document.getElementById("executionMessage").style.color = "red";
        }
    });

    // å¼€å§‹ç›‘æ§æ‰§è¡ŒçŠ¶æ€
    function startStatusMonitoring() {
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
        }
        
        statusCheckInterval = setInterval(async () => {
            if (!currentProcessId) {
                return;
            }

            try {
                const response = await fetch(`/execution_status/${currentProcessId}`);
                const status = await response.json();

                if (response.ok) {
                    updateExecutionStatus(status);
                } else {
                    console.error('Status check failed:', status.error);
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
        }, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
    }

    // åœæ­¢ç›‘æ§æ‰§è¡ŒçŠ¶æ€
    function stopStatusMonitoring() {
        if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
        }
        
        // é‡æ–°å¯ç”¨æ‰§è¡ŒæŒ‰é’®
        document.getElementById("executeTaskButton").disabled = false;
        document.getElementById("executeTaskButton").innerText = "ğŸ¤– æ‰§è¡ŒåŠ¨ä½œåºåˆ—";
        
        // éšè—åœæ­¢æŒ‰é’®
        document.getElementById("stopExecutionButton").style.display = "none";
        
        currentProcessId = null;
    }

    // æ›´æ–°æ‰§è¡ŒçŠ¶æ€æ˜¾ç¤º
    function updateExecutionStatus(status) {
        const messageElement = document.getElementById("executionMessage");
        
        if (status.status === 'running') {
            messageElement.innerHTML = "ğŸ¤– " + status.message;
            messageElement.style.color = "blue";
        } else if (status.status === 'completed') {
            messageElement.innerHTML = "âœ… " + status.message;
            messageElement.style.color = "green";
            stopStatusMonitoring();
        } else if (status.status === 'failed') {
            messageElement.innerHTML = "â— " + status.message;
            if (status.error) {
                messageElement.innerHTML += `<br><details><summary>è¯¦ç»†é”™è¯¯ä¿¡æ¯</summary><pre>${status.error}</pre></details>`;
            }
            messageElement.style.color = "red";
            stopStatusMonitoring();
        } else if (status.status === 'stopped') {
            messageElement.innerHTML = "â¹ï¸ " + status.message;
            messageElement.style.color = "orange";
            stopStatusMonitoring();
        }
    }

    // å–æ¶ˆæŒ‰é’® - ä¸ä¿å­˜ç»“æœ
    document.getElementById("cancelTaskButton").addEventListener("click", () => {
        resetUI();
    });

    // é‡è¯•æŒ‰é’® - é‡æ–°å½•éŸ³
    document.getElementById("retryButton").addEventListener("click", async () => {
        resetUI();
        startRecording();
    });

    // é‡ç½®ç•Œé¢
    function resetUI() {
        document.getElementById("chinese-text").innerText = "ğŸ“ ä¸­æ–‡ï¼šç­‰å¾…å½•éŸ³ç»“æœ...";
        document.getElementById("english-text").innerText = "ğŸ“š è‹±æ–‡ï¼šç­‰å¾…ç¿»è¯‘ç»“æœ...";
        document.getElementById("actionButtons").style.display = "none";
        document.getElementById("taskResult").style.display = "none";
        document.getElementById("executionStatus").style.display = "none";
        currentOriginalText = "";
        currentTranslatedText = "";
        currentActionSequence = null;
        audioChunks = [];
        document.getElementById("recordButton").disabled = false;
        document.getElementById("stopButton").disabled = true;
        document.getElementById("executeTaskButton").disabled = false;
        document.getElementById("executeTaskButton").innerText = "ğŸ¤– æ‰§è¡ŒåŠ¨ä½œåºåˆ—";
        document.getElementById("stopExecutionButton").style.display = "none";
        
        // åœæ­¢çŠ¶æ€ç›‘æ§
        stopStatusMonitoring();
    }
</script>

</body>
</html>